name: Test Install Script

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-install:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-22.04]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y jq shellcheck

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install shellcheck

      - name: Run test suite
        run: ./tests/test.sh

      - name: Verify ShellCheck compliance
        run: |
          shellcheck -x install.sh
          shellcheck -x quick-install.sh
          shellcheck -x lib/*.sh
          shellcheck tests/test.sh
          shellcheck tests/helpers.sh
          # Use --severity=warning to ignore info-level source-path hints
          shellcheck --severity=warning -x tests/scenarios/*.sh

  # Naked install test - simulates a fresh user running the one-liner
  test-naked-install:
    name: Naked Install (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-22.04]
    runs-on: ${{ matrix.os }}
    # No checkout - simulates fresh user environment

    steps:
      - name: Verify prerequisites (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          echo "Checking prerequisites..."
          git --version
          curl --version | head -1

      - name: Verify prerequisites (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "Checking prerequisites..."
          git --version
          brew --version | head -1

      - name: Run one-liner install
        env:
          CLAUDE_SETUP_BRANCH: ${{ github.head_ref || github.ref_name }}
          CLAUDE_SETUP_REPO: ${{ github.repository }}
        run: |
          curl -fsSL "https://raw.githubusercontent.com/${{ github.repository }}/${{ github.head_ref || github.ref_name }}/quick-install.sh" | bash

      - name: Install Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code
          # Use Bedrock mode to avoid API key requirement
          CLAUDE_CODE_USE_BEDROCK=1 claude --version

      - name: Verify installation
        run: |
          echo "Verifying installation..."

          # Check key directories and files
          [[ -f ~/.claude/CLAUDE.md ]] || { echo "FAIL: ~/.claude/CLAUDE.md missing"; exit 1; }
          [[ -d ~/.claude/commands ]] || { echo "FAIL: ~/.claude/commands missing"; exit 1; }
          [[ -d ~/.claude/skills ]] || { echo "FAIL: ~/.claude/skills missing"; exit 1; }

          # Check at least one command exists
          [[ -f ~/.claude/commands/init-project.md ]] || { echo "FAIL: init-project command missing"; exit 1; }

          # Check installed.json has content_version
          [[ -f ~/.claude/installed.json ]] || { echo "FAIL: installed.json missing"; exit 1; }
          version=$(jq -r '.content_version // 0' ~/.claude/installed.json)
          [[ "$version" -gt 0 ]] || { echo "FAIL: content_version not set"; exit 1; }

          echo ""
          echo "Installation verified successfully"
          echo "  Version: $version"
          echo "  Commands: $(ls ~/.claude/commands | wc -l | tr -d ' ')"
          echo "  Skills: $(ls ~/.claude/skills | wc -l | tr -d ' ')"

      - name: Verify ccstatusline
        run: |
          echo "Verifying ccstatusline configuration..."

          # Check settings.json has statusLine
          [[ -f ~/.claude/settings.json ]] || { echo "FAIL: settings.json missing"; exit 1; }
          statusline=$(jq -r '.statusLine // ""' ~/.claude/settings.json)
          [[ -n "$statusline" ]] || { echo "FAIL: statusLine not configured"; exit 1; }
          echo "  statusLine: $statusline"

          # Check ccstatusline config exists
          [[ -f ~/.config/ccstatusline/settings.json ]] || { echo "FAIL: ccstatusline config missing"; exit 1; }
          echo "  ccstatusline config: exists"

          echo ""
          echo "ccstatusline verified successfully"
