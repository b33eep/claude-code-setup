name: Test Install Script

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-install:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-22.04]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y jq shellcheck

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install shellcheck

      - name: Run test suite
        run: ./tests/test.sh

      - name: Verify ShellCheck compliance
        run: |
          shellcheck -x install.sh
          shellcheck -x quick-install.sh
          shellcheck -x lib/*.sh
          shellcheck tests/test.sh
          shellcheck tests/helpers.sh
          # Use --severity=warning to ignore info-level source-path hints
          shellcheck --severity=warning -x tests/scenarios/*.sh

  # Naked install test - simulates a fresh user running the one-liner
  test-naked-install:
    name: Naked Install (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-22.04]
    runs-on: ${{ matrix.os }}
    # No checkout - simulates fresh user environment

    steps:
      - name: Verify prerequisites (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          echo "Checking prerequisites..."
          git --version
          curl --version | head -1

      - name: Verify prerequisites (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "Checking prerequisites..."
          git --version
          brew --version | head -1

      - name: Run one-liner install
        env:
          CLAUDE_SETUP_BRANCH: ${{ github.head_ref || github.ref_name }}
          CLAUDE_SETUP_REPO: ${{ github.repository }}
        run: |
          curl -fsSL "https://raw.githubusercontent.com/${{ github.repository }}/${{ github.head_ref || github.ref_name }}/quick-install.sh" | bash

      - name: Install Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code
          # Use Bedrock mode to avoid API key requirement
          CLAUDE_CODE_USE_BEDROCK=1 claude --version

      - name: Verify installation
        run: |
          echo "Verifying installation..."

          # Check key directories and files
          [[ -f ~/.claude/CLAUDE.md ]] || { echo "FAIL: ~/.claude/CLAUDE.md missing"; exit 1; }
          [[ -d ~/.claude/commands ]] || { echo "FAIL: ~/.claude/commands missing"; exit 1; }
          [[ -d ~/.claude/skills ]] || { echo "FAIL: ~/.claude/skills missing"; exit 1; }

          # Check at least one command exists
          [[ -f ~/.claude/commands/init-project.md ]] || { echo "FAIL: init-project command missing"; exit 1; }

          # Check installed.json has content_version
          [[ -f ~/.claude/installed.json ]] || { echo "FAIL: installed.json missing"; exit 1; }
          version=$(jq -r '.content_version // 0' ~/.claude/installed.json)
          [[ "$version" -gt 0 ]] || { echo "FAIL: content_version not set"; exit 1; }

          echo ""
          echo "Installation verified successfully"
          echo "  Version: $version"
          echo "  Commands: $(ls ~/.claude/commands | wc -l | tr -d ' ')"
          echo "  Skills: $(ls ~/.claude/skills | wc -l | tr -d ' ')"

      - name: Verify ccstatusline config
        run: |
          echo "Verifying ccstatusline configuration..."

          # Check settings.json has statusLine
          [[ -f ~/.claude/settings.json ]] || { echo "FAIL: settings.json missing"; exit 1; }
          statusline=$(jq -r '.statusLine // ""' ~/.claude/settings.json)
          [[ -n "$statusline" ]] || { echo "FAIL: statusLine not configured"; exit 1; }
          echo "  statusLine: $statusline"

          # Check ccstatusline config exists
          [[ -f ~/.config/ccstatusline/settings.json ]] || { echo "FAIL: ccstatusline config missing"; exit 1; }
          echo "  ccstatusline config: exists"

          echo ""
          echo "ccstatusline config verified successfully"

      - name: Test ccstatusline execution
        run: |
          echo "Testing ccstatusline execution..."

          # Run ccstatusline with empty JSON input (simulates Claude Code calling it)
          # The -y flag should prevent any interactive prompts during npm package download
          output=$(echo '{}' | npx -y ccstatusline@latest 2>&1)
          exit_code=$?

          if [[ $exit_code -eq 0 ]] && [[ -n "$output" ]]; then
            echo "  ccstatusline executed successfully"
            echo "  Output: $output"
          else
            echo "FAIL: ccstatusline execution failed"
            echo "  Exit code: $exit_code"
            echo "  Output: $output"
            exit 1
          fi

          echo ""
          echo "ccstatusline E2E test passed"

      - name: Test Claude session with statusLine
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Skip if no API key configured
          if [[ -z "$ANTHROPIC_API_KEY" ]]; then
            echo "Skipping Claude session test (ANTHROPIC_API_KEY secret not configured)"
            echo "To enable: Add ANTHROPIC_API_KEY secret to repository settings"
            exit 0
          fi

          echo "Testing Claude session with statusLine..."

          # Run a minimal Claude session to verify statusLine works
          # Using -p (print mode) for non-interactive execution
          # The statusLine command will be executed by Claude during startup
          output=$(claude -p "Say 'test ok' and nothing else" 2>&1) || true

          # Check for settings/statusLine errors in output
          if echo "$output" | grep -qi "error.*statusline\|settings.*error\|failed.*status"; then
            echo "FAIL: Claude reported statusLine/settings error"
            echo "Output: $output"
            exit 1
          fi

          # Check that Claude responded (proves session started successfully)
          if echo "$output" | grep -qi "test ok\|ok"; then
            echo "  Claude session started successfully"
            echo "  Response received: ${output:0:100}..."
          else
            echo "  Warning: Unexpected response, but no errors detected"
            echo "  Output: ${output:0:200}..."
          fi

          echo ""
          echo "Claude session E2E test passed"
