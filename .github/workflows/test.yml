name: Test Install Script

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-install:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test --help
        run: ./install.sh --help

      - name: Test --list (before install)
        run: ./install.sh --list

      - name: Test fresh install (non-interactive)
        run: |
          # Remove installed.json from --list test to start fresh
          rm -f ~/.claude/installed.json
          # Modules are alphabetically sorted:
          # Standards: 1=design-patterns, 2=python, 3=typescript
          # MCP: 1=brave-search, 2=google-search, 3=pdf-reader
          # Skills: 1=create-slidev-presentation
          # Select python(2) + typescript(3), pdf-reader(3), slidev(1)
          echo -e "2 3\n3\n1" | ./install.sh

      - name: Verify installation
        run: |
          # Check files exist
          test -f ~/.claude/CLAUDE.md
          test -f ~/.claude/installed.json
          test -d ~/.claude/commands
          test -f ~/.claude.json

          # Check CLAUDE.md contains selected standards
          grep -q "Python Standards" ~/.claude/CLAUDE.md
          grep -q "TypeScript Standards" ~/.claude/CLAUDE.md

          # Check installed.json tracks modules
          cat ~/.claude/installed.json
          jq -e '.standards | length > 0' ~/.claude/installed.json

          # Check MCP config
          jq -e '.mcpServers["pdf-reader"]' ~/.claude.json

          # Check skills installed
          test -d ~/.claude/skills/create-slidev-presentation

      - name: Test --list (after install)
        run: ./install.sh --list

      - name: Test --add standards (non-interactive)
        run: |
          # Add design-patterns (standards only)
          # After fresh install: python, typescript installed
          # Available: 1=design-patterns
          echo -e "1\nnone\nnone" | ./install.sh --add

      - name: Test --add MCP with API key (non-interactive)
        run: |
          # Add brave-search with dummy API key
          # Standards: all installed (no prompt)
          # MCP: 1=brave-search, 2=google-search available
          # Skills: all installed (no prompt)
          echo -e "1\ntest-dummy-api-key" | ./install.sh --add

      - name: Verify MCP with API key
        run: |
          # Check brave-search is configured with the dummy key
          jq -e '.mcpServers["brave-search"]' ~/.claude.json
          jq -e '.mcpServers["brave-search"].env.BRAVE_API_KEY == "test-dummy-api-key"' ~/.claude.json

      - name: Test --update
        run: ./install.sh --update

      - name: Final verification
        run: |
          echo "=== CLAUDE.md ==="
          head -50 ~/.claude/CLAUDE.md
          echo ""
          echo "=== installed.json ==="
          cat ~/.claude/installed.json
          echo ""
          echo "=== .claude.json ==="
          cat ~/.claude.json
